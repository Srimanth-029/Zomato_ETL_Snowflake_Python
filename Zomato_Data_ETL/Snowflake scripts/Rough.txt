-- SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.RAW_JSON_DATA;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.DIM_CURRENCY;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.CITY;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.COUNTRY;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.DIM_RESTAURANT_EVENT_PHOTOS;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.RESTAURANT_CUISINE;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.RESTAURANT_DATA_MAPPING_TABLE_EXTRACT;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.RESTAURANT_DATA_MAPPING_TABLE_TRANSFORMED;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.RESTAURANT_DISCLAIMER;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.RESTAURANT_LOCATION;
SELECT * FROM ZOMATO_ETL.STAGE.RESTAURANT_EVENTS WHERE IS_ACITVE = 0;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.GEOGRAPHIC_DIM;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.RESTAURANTS;
SELECT COUNT(*) FROM ZOMATO_ETL.STAGE.USER_RATING;


-- SELECT COUNT(*) FROM ZOMATO_ETL.DBO.RATING_HISTORY; --View
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.DIM_CURRENCY; --4
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.DIM_RESTAURANT_EVENT_PHOTOS; --152
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.GEOGRAPHIC_DIM; --2761
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.RESTAURANTS; --2992
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.RESTAURANT_DISCLAIMER; --1
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.RESTAURANT_EVENTS; --140
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.CITY; --24
-- SELECT COUNT(*) FROM ZOMATO_ETL.DBO.DATE_DIM;
-- SELECT COUNT(*) FROM ZOMATO_ETL.DBO.EVENTS_HISTORY; --View
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.RESTAURANT_CUISINE; --81
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.RESTAURANT_LOCATION; --2992
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.COUNTRY; --15
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.RESTAURANT_DATA_MAPPING_TABLE; --6295
SELECT COUNT(*) FROM ZOMATO_ETL.DBO.USER_RATING; --2992
-- SELECT COUNT(*) FROM ZOMATO_ETL.DBO.USER_RATING_HISTORY; --History_Table_Not_Necessary


select TIMESTAMPDIFF(SECONDS,CURRENT_TIMESTAMP(),NEXT_SCHEDULED_TIME) Next_Run_Sec,* from table(information_schema.task_history()) 
-- where state = 'SCHEDULED'
ORDER BY COMPLETED_TIME DESC;

select current_timestamp();

SELECT * FROM TABLE(INFORMATION_SCHEMA.CURRENT_TASK_GRAPHS())
select * from table(information_schema.task_history())






















 SELECT
        RESTAURANT_ID
        ,RESTAURANT_NAME
        ,RESTAURANT_AVERAGE_COST_FOR_TWO
        ,RESTAURANT_CUISINE
        ,RESTAURANT_CURRENCY
        ,CITY
        ,COUNTRY
        ,ADDRESS
        ,LOCALITY
        ,ZIPCODE
        ,LATTITUDE,
        LONGITUDE
        ,HAS_ONLINE_DELIVERY
        ,HAS_TABLE_BOOKING
        ,TRUE
        ,CREATED_BY
        ,CREATED_DATE
        ,RESTAURANT_EVENT_ID

FROM(        
WITH CTE_NEWEVENTS(RESTAURANT_ID,RESTAURANT_NAME,RESTAURANT_AVERAGE_COST_FOR_TWO,RESTAURANT_CUISINE,RESTAURANT_CURRENCY,CITY,COUNTRY
        ,ADDRESS,LOCALITY,ZIPCODE,LATTITUDE,LONGITUDE,HAS_ONLINE_DELIVERY,HAS_TABLE_BOOKING,IS_ACTIVE,CREATED_BY,CREATED_DATE,RESTAURANT_EVENT_ID) AS(
    SELECT e.RESTAURANT_ID,E.RESTAURANT_NAME,E.RESTAURANT_AVERAGE_COST_FOR_TWO,E.RESTAURANT_CUISINE,E.RESTAURANT_CURRENCY,E.CITY,E.COUNTRY
    ,E.ADDRESS,E.LOCALITY,E.ZIPCODE,E.LATTITUDE,E.LONGITUDE,
    E.HAS_ONLINE_DELIVERY,E.HAS_TABLE_BOOKING,TRUE,E.CREATED_BY,E.CREATED_DATE,E.RESTAURANT_EVENT_ID
    FROM ZOMATO_ETL.STAGE.Restaurant_Data_Mapping_Table_Extract e
    LEFT JOIN ZOMATO_ETL.DBO.RESTAURANTS R
    ON R.RESTAURANT_ID = E.RESTAURANT_ID
    AND E.RESTAURANT_NAME = R.RESTAURANT_NAME
    LEFT JOIN DATE_DIM DS
    ON DS.DATE = DATE(E.EVENT_START_DATE)
    LEFT JOIN DATE_DIM DE
    ON DE.DATE = DATE(E.EVENT_END_DATE)
    LEFT JOIN ZOMATO_ETL.DBO.RESTAURANT_EVENTS RE
    ON RE.RESTAURANT_ID = R.RESTAURANT_PK_ID
    AND RE.EVENT_ID = E.RESTAURANT_EVENT_ID
    and re.event_title = E.EVENT_NAME
    AND RE.EVENT_START_DATE_ID = DS.DATE_ID
    AND RE.EVENT_END_DATE_ID = DE.DATE_ID
    WHERE  e.RESTAURANT_EVENT_ID is not null and re.event_id is null
    )
,CTE_NEWCUISINES AS(
    SELECT e.RESTAURANT_ID,E.RESTAURANT_NAME,E.RESTAURANT_AVERAGE_COST_FOR_TWO,E.RESTAURANT_CUISINE,E.RESTAURANT_CURRENCY,E.CITY,E.COUNTRY
    ,E.ADDRESS,E.LOCALITY,E.ZIPCODE,E.LATTITUDE,E.LONGITUDE,
    E.HAS_ONLINE_DELIVERY,E.HAS_TABLE_BOOKING,TRUE,E.CREATED_BY,E.CREATED_DATE,E.RESTAURANT_EVENT_ID
    FROM ZOMATO_ETL.STAGE.Restaurant_Data_Mapping_Table_Extract e
    JOIN ZOMATO_ETL.DBO.RESTAURANTS R
    ON R.RESTAURANT_ID = E.RESTAURANT_ID
    AND E.RESTAURANT_NAME = R.RESTAURANT_NAME
    JOIN ZOMATO_ETL.DBO.RESTAURANT_CUISINE RC
    ON RC.CUISINE =E.RESTAURANT_CUISINE
    LEFT JOIN DATE_DIM DS
    ON DS.DATE = DATE(E.EVENT_START_DATE)
    LEFT JOIN DATE_DIM DE
    ON DE.DATE = DATE(E.EVENT_END_DATE)
    LEFT JOIN ZOMATO_ETL.DBO.RESTAURANT_EVENTS RE
    ON RE.RESTAURANT_ID = R.RESTAURANT_PK_ID
    AND RE.EVENT_ID = E.RESTAURANT_EVENT_ID
    and re.event_title = E.EVENT_NAME
    AND RE.EVENT_START_DATE_ID = DS.DATE_ID
    AND RE.EVENT_END_DATE_ID = DE.DATE_ID
    LEFT JOIN ZOMATO_ETL.DBO.RESTAURANT_DATA_MAPPING_TABLE M
    ON M.RESTAURANT_ID = R.RESTAURANT_PK_ID
    AND M.RESTAURANT_CUISINE_ID = RC.RESTAURANT_CUISINE_ID
    AND COALESCE(M.RESTAURANT_EVENT_ID,-1) = COALESCE(RE.RESTAURANT_EVENT_ID,-1)
    WHERE M.Restaurant_Mapping_Id IS NULL
)
,CTE_NEWRESTAURANT AS(
    SELECT e.RESTAURANT_ID,E.RESTAURANT_NAME,E.RESTAURANT_AVERAGE_COST_FOR_TWO,E.RESTAURANT_CUISINE,E.RESTAURANT_CURRENCY,E.CITY,E.COUNTRY
    ,E.ADDRESS,E.LOCALITY,E.ZIPCODE,E.LATTITUDE,E.LONGITUDE,
    E.HAS_ONLINE_DELIVERY,E.HAS_TABLE_BOOKING,TRUE,E.CREATED_BY,E.CREATED_DATE,E.RESTAURANT_EVENT_ID
    FROM ZOMATO_ETL.STAGE.Restaurant_Data_Mapping_Table_Extract e
    LEFT JOIN ZOMATO_ETL.DBO.RESTAURANTS R
    ON R.RESTAURANT_ID = E.RESTAURANT_ID
    AND E.RESTAURANT_NAME = R.RESTAURANT_NAME
    WHERE R.RESTAURANT_ID IS NULL
)
    SELECT * FROM CTE_NEWEVENTS
    UNION
    SELECT * FROM CTE_NEWCUISINES
    UNION
    SELECT * FROM CTE_NEWRESTAURANT
    ORDER BY RESTAURANT_ID
) M
    SELECT * FROM CTE_1

    SELECT * FROM ZOMATO_ETL.DBO.RESTAURANT_DATA_MAPPING_TABLE M
    
    select * from error_log
    order by 1 desc;

    select * from ZOMATO_ETL.STAGE.raw_json_data;
    SELECT * FROM RESTAURANTS WHERE RESTAURANT_NAME = 'Anthera' RESTAURANT_ID = 313256;
    SELECT *
    FROM ZOMATO_ETL.dbo.Restaurant_Events WHERE 
    -- event_id = 110863341 
    IS_ACITVE = FALSE; --29896, 104308
    WHERE restaurant_id = 30080;
    SELECT DATE(EVENT_START_DATE),* FROM ZOMATO_ETL.STAGE.Restaurant_Data_Mapping_Table_Extract WHERE
    RESTAURANT_ID = 18089255;
    RESTAURANT_EVENT_ID = 118466;
    SELECT * FROM RESTAURANT_EVENTS WHERE
    SELECT * FROM RESTAURANTS ORDER BY 1 DESC
    SELECT * FROM RESTAURANT_DATA_MAPPING_TABLE
    WHERE RESTAURANT_ID = 32901
    order  by restaurant_event_id;

    SELECT * FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) -- where state = 'scheduled'
    ORDER BY SCHEDULED_TIME DESC
SELECT CURRENT_TIMESTAMP()
    SELECT RESTAURANT_ID,RESTAURANT_AVERAGE_COST_FOR_TWO,RESTAURANT_CUISINE_ID,RESTAURANT_CURRENCY_ID,RESTAURANT_LOCATION_ID,HAS_ONLINE_DELIVERY,HAS_TABLE_BOOKING,RESTAURANT_RATING_ID,RESTAURANT_EVENT_ID,IS_ACTIVE,CREATED_BY,CREATED_DATE 
    FROM ZOMATO_ETL.STAGE.Restaurant_Data_Mapping_Table_Transformed
    ORDER BY RESTAURANT_ID , RESTAURANT_EVENT_ID

    SELECT DISTINCT  e.value:restaurant:R:res_id::string S,e.value:restaurant:name::string,e.value:restaurant:average_cost_for_two::string,e.value:restaurant:currency::string,e.value:restaurant:location:city::string,e.value:restaurant:location:country_id,e.value:restaurant:location:address::string,e.value:restaurant:location:locality::string,e.value:restaurant:location:zipcode::string,e.value:restaurant:location:latitude::DECIMAL(28,10),e.value:restaurant:location:longitude::DECIMAL(28,10),e.value:restaurant:has_online_delivery::string,e.value:restaurant:has_table_booking::string,z.value:event:event_id::String eve,TRIM(m.value)::string RESTAURANT_CUISINE,current_user(),current_timestamp()
        FROM ZOMATO_ETL.STAGE.RAW_JSON_DATA t, table(flatten(t.Data)) f,table(flatten(f.value:restaurants)) e,table(flatten(e.value:restaurant:zomato_events)) z,table(flatten(split(e.value:restaurant:cuisines,','))) m




SELECT e.value:restaurant:R:res_id::string,e.value:restaurant:name::String,z.value:event:event_id::String,
z.value:event:title::String,z.value:event:description::String,z.value:event:disclaimer::String,z.value:event:start_date::String,z.value:event:end_date::String,z.value:event:start_time::String,z.value:event:end_time::String,z.value:event:is_active::String
    FROM ZOMATO_ETL.STAGE.RAW_JSON_DATA t, table(flatten(t.Data)) f,table(flatten(f.value:restaurants)) e,table(flatten(e.value:restaurant:zomato_events)) z;